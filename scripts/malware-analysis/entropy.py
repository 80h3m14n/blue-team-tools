#!/usr/bin/env python3

import math
import argparse
import sys
from collections import Counter


# ----------------------------
# File Type Detection (Magic Bytes)
# ----------------------------
def detect_file_type(filepath):
    try:
        with open(filepath, "rb") as f:
            header = f.read(16)
    except Exception:
        return "Unknown"

    signatures = {
        b"\x89PNG\r\n\x1a\n": "PNG image",
        b"\xFF\xD8\xFF": "JPEG image",
        b"GIF87a": "GIF image",
        b"GIF89a": "GIF image",
        b"PK\x03\x04": "ZIP archive",
        b"PK\x05\x06": "ZIP archive (empty)",
        b"PK\x07\x08": "ZIP archive (spanned)",
        b"%PDF": "PDF document",
        b"MZ": "Windows executable (EXE)",
        b"\x7fELF": "Linux executable (ELF)",
        b"ID3": "MP3 audio",
    }

    for sig, name in signatures.items():
        if header.startswith(sig):
            return name

    return "Unknown"


# ----------------------------
# Entropy Calculation
# ----------------------------
def calculate_entropy(filepath, chunk_size=8192):
    byte_counts = Counter()
    total_bytes = 0

    with open(filepath, 'rb') as f:
        while chunk := f.read(chunk_size):
            byte_counts.update(chunk)
            total_bytes += len(chunk)

    if total_bytes == 0:
        return 0.0, 0

    entropy = 0
    for count in byte_counts.values():
        p = count / total_bytes
        entropy -= p * math.log2(p)

    return entropy, total_bytes


# ----------------------------
# Smart Classification
# ----------------------------
def classify(entropy, file_type):
    assessment = []

    # Entropy classification
    if entropy > 7.8:
        entropy_class = "Very high entropy"
    elif entropy > 6.5:
        entropy_class = "High entropy"
    elif entropy > 4.0:
        entropy_class = "Moderate entropy"
    else:
        entropy_class = "Low entropy"

    assessment.append(entropy_class)

    # File type expectation logic
    compressed_types = ["PNG", "JPEG", "ZIP", "PDF", "MP3"]
    executable_types = ["EXE", "ELF"]

    if any(t in file_type for t in compressed_types):
        if entropy < 7.5:
            assessment.append("⚠ Unexpectedly low entropy for compressed format")
        else:
            assessment.append("Entropy consistent with compressed format")

    elif any(t in file_type for t in executable_types):
        if entropy > 7.7:
            assessment.append("⚠ Possibly packed or encrypted executable")
        else:
            assessment.append("Typical executable entropy")

    else:
        if entropy > 7.8:
            assessment.append("⚠ High entropy for unknown file type (possible encryption)")
        else:
            assessment.append("No strong anomalies detected")

    return " | ".join(assessment)


# ----------------------------
# Main
# ----------------------------
def main():
    parser = argparse.ArgumentParser(
        description="Entropy + File Type Analyzer",
        epilog="Example: python entropy.py sample.bin -v"
    )

    parser.add_argument("file", help="File to analyze")
    parser.add_argument("-c", "--chunk-size", type=int, default=8192)
    parser.add_argument("-n", "--normalize", action="store_true")
    parser.add_argument("-v", "--verbose", action="store_true")

    args = parser.parse_args()

    try:
        file_type = detect_file_type(args.file)
        entropy, size = calculate_entropy(args.file, args.chunk_size)

        print(f"\nFile: {args.file}")
        print(f"Detected Type: {file_type}")
        print(f"Size: {size} bytes")
        print(f"Entropy: {entropy:.4f} bits/byte")

        if args.normalize:
            print(f"Normalized: {entropy / 8:.4f}")

        print(f"Assessment: {classify(entropy, file_type)}")

    except FileNotFoundError:
        print("[!] File not found.")
        sys.exit(1)
    except PermissionError:
        print("[!] Permission denied.")
        sys.exit(1)
    except KeyboardInterrupt:
        print("\n[!] Interrupted by user.")
        sys.exit(130)


if __name__ == "__main__":
    main()
