# File: /etc/sysctl.d/99-system-hardening.conf
# Purpose:   Security hardening parameters inspired by Lynis audit results
# Discalimer: Use at your own risk
# Author:    80h3m14n (based on Grok recommendations - February 2026)
# Created:   Safe subset – avoids high-risk settings that can break drivers/modules
#
# Check (Before usage):
# sudo sysctl -n   kernel.kptr_restrict   kernel.yama.ptrace_scope   kernel.modules_disabled   net.ipv4.conf.all.forwarding   net.ipv4.conf.all.rp_filter   net.ipv4.conf.all.log_martians   net.ipv4.conf.all.accept_redirects   net.ipv4.icmp_echo_ignore_broadcasts   fs.protected_fifos   fs.protected_hardlinks   fs.protected_regular   fs.protected_symlinks   fs.suid_dumpable   kernel.dmesg_restrict   kernel.sysrq   kernel.unprivileged_bpf_disabled   dev.tty.ldisc_autoload
#
# Usage:     sudo cp this-file /etc/sysctl.d/
#            sudo sysctl --system
#            Reboot recommended to ensure all settings apply
# Revert:    sudo rm /etc/sysctl.d/99-safe-lynis-hardening.conf
#            sudo sysctl --system
# Caution:   Test after applying (Wi-Fi, USB, graphics, debuggers)
#            Monitor dmesg / journalctl for warnings

# ────────────────────────────────────────────────
# Kernel memory & information leak protection
# ────────────────────────────────────────────────

# Hides kernel symbol addresses from non-root users
# Improves ASLR/kASLR effectiveness against exploits
# Current value on your system: 0
# Recommended: 2 (strictest safe value)
kernel.kptr_restrict = 2

# ────────────────────────────────────────────────
# Process tracing / debugging restrictions (Yama LSM)
# ────────────────────────────────────────────────

# Restricts ptrace() calls (used by debuggers like gdb, strace)
# Value 1 = only allow tracing direct child processes (good balance)
# Value 2 = almost completely disable ptrace for non-root (very strict)
# Current value on your system: 0 (unrestricted)
# Fedora often forces 0 due to elfutils-default-yama-scope package
# Side effect: may break gdb, IDE debuggers, some perf tools
# Recommendation: start with 1; change to 2 only if you never debug
kernel.yama.ptrace_scope = 1

# ────────────────────────────────────────────────
# Network stack hardening (IPv4)
# ────────────────────────────────────────────────

# Disable IP forwarding (prevents machine acting as router if compromised)
# Your current value: 1 (enabled – unusual for desktop!)
# Should almost always be 0 unless you're doing NAT/routing
net.ipv4.conf.all.forwarding = 0

# Enable strict reverse path filtering (anti IP spoofing)
# Drops packets with impossible source addresses
# Current value: 0
# Safe and strongly recommended
net.ipv4.conf.all.rp_filter = 1

# Log packets with impossible addresses (martians)
# Helps detect spoofing/attacks (minor log noise possible)
# Current value: 0
net.ipv4.conf.all.log_martians = 1

# ────────────────────────────────────────────────
# File system namespace & symlink protections
# ────────────────────────────────────────────────

# Stricter protection against writing to FIFOs in world-writable directories
# Mitigates symlink / hardlink races
# Current: 1 → set to 2 (strictest)
fs.protected_fifos = 2

# Stricter protection for regular files in world-writable dirs
# Current: 1 → set to 2
fs.protected_regular = 2

# Disable core dumps for setuid binaries (prevents sensitive data leaks)
# Current: 2 (allows dumps) → set to 0
fs.suid_dumpable = 0

# ────────────────────────────────────────────────
# Kernel feature restrictions
# ────────────────────────────────────────────────

# Completely disable SysRq key (magic sysrq)
# Prevents local exploits / accidental reboots via keyboard
# Current: 16 (partial enabled) → 0 = fully disabled
# Safe unless you rely on SysRq for recovery
kernel.sysrq = 0

# Prevent autoloading of tty line disciplines
# Closes a niche unprivileged exploit vector
# Current: 1 → set to 0
dev.tty.ldisc_autoload = 0

# ────────────────────────────────────────────────
# Settings ALREADY GOOD on your Fedora 43 – kept for documentation
# ────────────────────────────────────────────────
# kernel.dmesg_restrict                  = 1 (already good)
# fs.protected_hardlinks                 = 1 (already good)
# fs.protected_symlinks                  = 1 (already good)
# net.ipv4.icmp_echo_ignore_broadcasts   = 1 (already good)
# net.ipv4.conf.all.accept_redirects     = 0 (already good)
# kernel.unprivileged_bpf_disabled       = 2 (already stricter than proposed)

# ────────────────────────────────────────────────
# Intentionally OMITTED (high risk of breakage)
# ────────────────────────────────────────────────
# kernel.modules_disabled = 1
#   → Can prevent loading drivers after boot (NVIDIA, Wi-Fi, USB, etc.)
#   → Cannot be easily reverted without reboot
#   → Avoid unless you're on a very locked-down server

